<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Fabric.js Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.19/fabric.min.js"></script>
</head>
<body>
<canvas id="canvasId"></canvas>
</body>

<style>
    canvas{
        width: 100%;
        height: 100%;
    }
    body{
        overflow: hidden;
    }
</style>

<script>



    let screenWidth = window.innerWidth;
    let screenHeight = window.innerHeight;
    let canvas = new fabric.Canvas(document.getElementById('canvasId'))

    var myBrush = new fabric.PencilBrush(canvas);
    myBrush._setBrushStyles({}); // disable auto-smoothing
    canvas.freeDrawingBrush = myBrush;

    canvas.isDrawingMode = true;
    canvas.freeDrawingBrush.width = 3;
    canvas.freeDrawingBrush.color = 'black';
    canvas.enableTouchEvents = true;
    canvas.freeDrawingBrush.strokeWidth = 2;
    canvas.freeDrawingBrush.minStrokeWidth = 1;
    canvas.on('object:added',function(){
        if(!isRedoing){
            history = [];
        }
        isRedoing = false;
    });

    let isRedoing = false;
    let history = [];
    function undo(){
        if(canvas._objects.length>0){
            history.push(canvas._objects.pop());
            canvas.renderAll();
        }
    }
    function redo(){

        if(history.length>0){
            isRedoing = true;
            canvas.add(history.pop());
        }
    }



    canvas.setDimensions({
        width: screenWidth,
        height: screenHeight
    });

    // Add an event listener to detect changes in screen size
    window.addEventListener('resize', function() {
        // Get the new screen dimensions
        var newScreenWidth = window.innerWidth;
        var newScreenHeight = window.innerHeight;

        // Update the canvas dimensions
        canvas.setDimensions({
            width: newScreenWidth,
            height: newScreenHeight
        });
    });


    canvas.on('path:created', function(e) {

        e.path.set();
        canvas.renderAll();

    });


    document.addEventListener("keydown", function(event) {
        if (event.ctrlKey && event.code === 'KeyZ') {
          undo();
        }

    });

    document.addEventListener("keydown", function(event) {
        if (event.ctrlKey && event.code === 'KeyY') {
            redo();
        }

    });

    document.addEventListener('keydown', function(event) {
        // Check if the "P" key was pressed
        if (event.key === 'p' || event.key === 'P') {
            var dataURL = canvas.toDataURL('image/jpeg');

            // Create an image object from the data URL
            var image = new Image();
            image.src = dataURL;

            // Create a link element and click it to download the image
            var link = document.createElement('a');
            link.download = 'canvas.jpg';
            link.href = dataURL;
            link.click();

        }
    });

    document.addEventListener('keydown', function(event) {
        // Check if the "P" key was pressed
        if (event.key === 'e' || event.key === 'E') {
            changeAction('erase')
        }
        if (event.key === 'b' || event.key === 'B') {
            changeAction('brush')
        }
    });


    function changeAction(mode) {
        switch (mode) {
            case "brush":
                canvas.isDrawingMode = true;
                canvas.freeDrawingBrush = new fabric.PencilBrush(canvas)
                canvas.freeDrawingBrush.width = 10;
                canvas.freeDrawingBrush.color = 'red';
                break
            case "erase":
                canvas.isDrawingMode = true
                canvas.freeDrawingBrush = new fabric.EraserBrush(canvas)
                canvas.freeDrawingBrush.width = 10
                break
            case 'undoErasing':
                canvas.isDrawingMode = true
                canvas.freeDrawingBrush = new fabric.EraserBrush(canvas)
                canvas.freeDrawingBrush.width = 10
                canvas.freeDrawingBrush.inverted = true
            default:
                break
        }
    }



</script>
</html>
